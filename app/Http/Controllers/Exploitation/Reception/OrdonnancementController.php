<?php

namespace App\Http\Controllers\Exploitation\Reception;

use App\Http\Controllers\Controller;
use App\Http\Resources\Ordonnancement\OrdonnancementListeResource;
use App\Http\Resources\Ordonnancement\OrdonnancementResource;
use App\Interfaces\WithoutTrashControllerInterface;
use App\Models\Exploitation\Ordonnancement;
use App\Models\Exploitation\Paiement;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class OrdonnancementController extends Controller implements WithoutTrashControllerInterface
{
    public function all(): JsonResponse
    {
        $ordonnancements = Ordonnancement::with(['contrat' => ['personne', 'emplacement', 'annexe']])->get();
        return response()->json(['ordonnancements' => OrdonnancementListeResource::collection($ordonnancements)]);
    }

    public function getPaginate(): JsonResource
    {
        $ordonnancements = Ordonnancement::with(['contrat' => ['personne', 'emplacement', 'annexe']])->paginate(10);
        return OrdonnancementListeResource::collection($ordonnancements);
    }

    public function getSearch(string $search): JsonResource
    {
        $ordonnancements = Ordonnancement::with(['contrat' => ['personne', 'emplacement', 'annexe']])
            ->whereRaw("DATE_FORMAT(ordonnancements.created_at,'%d-%m-%Y') LIKE ?", "$search%")
            ->orWhere('code', 'LIKE', "%$search%")->paginate(10);
        return OrdonnancementListeResource::collection($ordonnancements);
    }

    public function unpaids(): JsonResponse
    {
        $ordonnancements = Ordonnancement::with(['contrat.personne', 'contrat.emplacement', 'contrat.annexe'])->unpaid()->get();
        return response()->json(['ordonnancements' => OrdonnancementResource::collection($ordonnancements)]);
    }

    public function store(Request $request): JsonResponse
    {
        $ordonnancement = new Ordonnancement($request->all());
        $ordonnancement->codeGenerate();
        $ordonnancement->save();
        $ordonnancement->impayer();
        foreach ($request->paiements as $payment) {
            $paiement = new Paiement();
            $paiement->ordonnancement_id = $ordonnancement->id;
            $paiement->facture_id = $payment['id'];
            $paiement->montant = $payment['montant'];
            $paiement->save();
        }
        $message = "L'ordonnancement $ordonnancement->code a été enregistré avec succès.";
        return response()->json(['message' => $message]);
    }

    public function update(int $id, Request $request): JsonResponse
    {
        $message = "Ordonnancement modifié avec succès.";
        return response()->json(['message' => $message]);
    }

    public function show(int $id): JsonResponse
    {
        $ordonnancement = Ordonnancement::with([
            'contrat.personne', 'contrat.emplacement', 'contrat.annexe', 'paiements.facture',
        ])->findOrFail($id);
        return response()->json(['ordonnancement' => OrdonnancementResource::make($ordonnancement)]);
    }
}
